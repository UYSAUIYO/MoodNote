import React, { useState, useEffect, useMemo, useRef } from 'react';
import {
  View,
  Text,
  TouchableOpacity,
  ScrollView,
  StyleSheet,
  Animated,
  Dimensions,
  FlatList,
} from 'react-native';
import { useTheme } from '../theme/ThemeContext';

const { width, height } = Dimensions.get('window');

interface EmojiPickerProps {
  visible: boolean;
  onEmojiSelect: (emoji: string) => void;
  onClose: () => void;
}

// è¡¨æƒ…åˆ†ç±»æ•°æ®
const EMOJI_CATEGORIES = {
  smileys: {
    name: 'ç¬‘è„¸',
    icon: 'ğŸ˜€',
    emojis: [
      'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ™ƒ',
      'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜™',
      'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”',
      'ğŸ¤', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ¤¥',
      'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®',
      'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ˜', 'ğŸ¤“',
      'ğŸ§', 'ğŸ˜•', 'ğŸ˜Ÿ', 'ğŸ™', 'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³', 'ğŸ¥º', 'ğŸ˜¦',
      'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜–', 'ğŸ˜£', 'ğŸ˜',
      'ğŸ˜“', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ¥±', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ˜ ', 'ğŸ˜ˆ', 'ğŸ‘¿'
    ]
  },
  people: {
    name: 'äººç‰©',
    icon: 'ğŸ‘¤',
    emojis: [
      'ğŸ‘¶', 'ğŸ§’', 'ğŸ‘¦', 'ğŸ‘§', 'ğŸ§‘', 'ğŸ‘±', 'ğŸ‘¨', 'ğŸ§”', 'ğŸ‘©', 'ğŸ§“',
      'ğŸ‘´', 'ğŸ‘µ', 'ğŸ™', 'ğŸ™', 'ğŸ™…', 'ğŸ™†', 'ğŸ’', 'ğŸ™‹', 'ğŸ§', 'ğŸ™‡',
      'ğŸ¤¦', 'ğŸ¤·', 'ğŸ‘®', 'ğŸ•µï¸', 'ğŸ’‚', 'ğŸ‘·', 'ğŸ¤´', 'ğŸ‘¸', 'ğŸ‘³', 'ğŸ‘²',
      'ğŸ§•', 'ğŸ¤µ', 'ğŸ‘°', 'ğŸ¤°', 'ğŸ¤±', 'ğŸ‘¼', 'ğŸ…', 'ğŸ¤¶', 'ğŸ¦¸', 'ğŸ¦¹',
      'ğŸ§™', 'ğŸ§š', 'ğŸ§›', 'ğŸ§œ', 'ğŸ§', 'ğŸ§', 'ğŸ§Ÿ', 'ğŸ’†', 'ğŸ’‡', 'ğŸš¶',
      'ğŸƒ', 'ğŸ’ƒ', 'ğŸ•º', 'ğŸ•´ï¸', 'ğŸ‘¯', 'ğŸ§–', 'ğŸ§—', 'ğŸ¤º', 'ğŸ‡', 'â›·ï¸',
      'ğŸ‚', 'ğŸŒï¸', 'ğŸ„', 'ğŸš£', 'ğŸŠ', 'â›¹ï¸', 'ğŸ‹ï¸', 'ğŸš´', 'ğŸšµ', 'ğŸ¤¸',
      'ğŸ¤¼', 'ğŸ¤½', 'ğŸ¤¾', 'ğŸ¤¹', 'ğŸ§˜', 'ğŸ›€', 'ğŸ›Œ', 'ğŸ‘­', 'ğŸ‘«', 'ğŸ‘¬'
    ]
  },
  animals: {
    name: 'åŠ¨ç‰©',
    icon: 'ğŸ¶',
    emojis: [
      'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯',
      'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ½', 'ğŸ¸', 'ğŸµ', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ’',
      'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ£', 'ğŸ¥', 'ğŸ¦†', 'ğŸ¦…', 'ğŸ¦‰', 'ğŸ¦‡',
      'ğŸº', 'ğŸ—', 'ğŸ´', 'ğŸ¦„', 'ğŸ', 'ğŸ›', 'ğŸ¦‹', 'ğŸŒ', 'ğŸ', 'ğŸœ',
      'ğŸ¦Ÿ', 'ğŸ¦—', 'ğŸ•·ï¸', 'ğŸ•¸ï¸', 'ğŸ¦‚', 'ğŸ¢', 'ğŸ', 'ğŸ¦', 'ğŸ¦–', 'ğŸ¦•',
      'ğŸ™', 'ğŸ¦‘', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦€', 'ğŸ¡', 'ğŸ ', 'ğŸŸ', 'ğŸ¬', 'ğŸ³',
      'ğŸ‹', 'ğŸ¦ˆ', 'ğŸŠ', 'ğŸ…', 'ğŸ†', 'ğŸ¦“', 'ğŸ¦', 'ğŸ¦§', 'ğŸ˜', 'ğŸ¦›',
      'ğŸ¦', 'ğŸª', 'ğŸ«', 'ğŸ¦’', 'ğŸ¦˜', 'ğŸƒ', 'ğŸ‚', 'ğŸ„', 'ğŸ', 'ğŸ–'
    ]
  },
  food: {
    name: 'é£Ÿç‰©',
    icon: 'ğŸ',
    emojis: [
      'ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸ«', 'ğŸˆ',
      'ğŸ’', 'ğŸ‘', 'ğŸ¥­', 'ğŸ', 'ğŸ¥¥', 'ğŸ¥', 'ğŸ…', 'ğŸ†', 'ğŸ¥‘', 'ğŸ¥¦',
      'ğŸ¥¬', 'ğŸ¥’', 'ğŸŒ¶ï¸', 'ğŸ«‘', 'ğŸŒ½', 'ğŸ¥•', 'ğŸ«’', 'ğŸ§„', 'ğŸ§…', 'ğŸ¥”',
      'ğŸ ', 'ğŸ¥', 'ğŸ¥–', 'ğŸ', 'ğŸ¥¨', 'ğŸ¥¯', 'ğŸ¥', 'ğŸ§‡', 'ğŸ§€', 'ğŸ–',
      'ğŸ—', 'ğŸ¥©', 'ğŸ¥“', 'ğŸ”', 'ğŸŸ', 'ğŸ•', 'ğŸŒ­', 'ğŸ¥ª', 'ğŸŒ®', 'ğŸŒ¯',
      'ğŸ«”', 'ğŸ¥™', 'ğŸ§†', 'ğŸ¥š', 'ğŸ³', 'ğŸ¥˜', 'ğŸ²', 'ğŸ«•', 'ğŸ¥£', 'ğŸ¥—',
      'ğŸ¿', 'ğŸ§ˆ', 'ğŸ§‚', 'ğŸ¥«', 'ğŸ±', 'ğŸ˜', 'ğŸ™', 'ğŸš', 'ğŸ›', 'ğŸœ',
      'ğŸ', 'ğŸ ', 'ğŸ¢', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¥®', 'ğŸ¡', 'ğŸ¥Ÿ', 'ğŸ¥ '
    ]
  },
  activities: {
    name: 'æ´»åŠ¨',
    icon: 'âš½',
    emojis: [
      'âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ±',
      'ğŸª€', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ', 'ğŸªƒ', 'ğŸ¥…', 'â›³',
      'ğŸª', 'ğŸ¹', 'ğŸ£', 'ğŸ¤¿', 'ğŸ¥Š', 'ğŸ¥‹', 'ğŸ½', 'ğŸ›¹', 'ğŸ›·', 'â›¸ï¸',
      'ğŸ¥Œ', 'ğŸ¿', 'â›·ï¸', 'ğŸ‚', 'ğŸª‚', 'ğŸ‹ï¸', 'ğŸ¤¸', 'ğŸ¤º', 'ğŸ¤¾', 'ğŸŒï¸',
      'ğŸ‡', 'ğŸ§˜', 'ğŸ„', 'ğŸŠ', 'ğŸ¤½', 'ğŸš£', 'ğŸ§—', 'ğŸšµ', 'ğŸš´', 'ğŸ†',
      'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ…', 'ğŸ–ï¸', 'ğŸµï¸', 'ğŸ—ï¸', 'ğŸ«', 'ğŸŸï¸', 'ğŸª',
      'ğŸ¤¹', 'ğŸ­', 'ğŸ©°', 'ğŸ¨', 'ğŸ¬', 'ğŸ¤', 'ğŸ§', 'ğŸ¼', 'ğŸµ', 'ğŸ¶',
      'ğŸ¥', 'ğŸª˜', 'ğŸ¹', 'ğŸ¥Š', 'ğŸ¯', 'ğŸ³', 'ğŸ®', 'ğŸ°', 'ğŸ§©', 'ğŸƒ'
    ]
  },
  travel: {
    name: 'æ—…è¡Œ',
    icon: 'ğŸš—',
    emojis: [
      'ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸšŒ', 'ğŸš', 'ğŸï¸', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš',
      'ğŸ›»', 'ğŸšš', 'ğŸš›', 'ğŸšœ', 'ğŸï¸', 'ğŸ›µ', 'ğŸš²', 'ğŸ›´', 'ğŸ›¹', 'ğŸ›¼',
      'ğŸš', 'ğŸ›¸', 'âœˆï¸', 'ğŸ›©ï¸', 'ğŸ›«', 'ğŸ›¬', 'ğŸª‚', 'ğŸ’º', 'ğŸš€', 'ğŸ›°ï¸',
      'ğŸš¢', 'â›µ', 'ğŸš¤', 'ğŸ›¥ï¸', 'ğŸ›³ï¸', 'â›´ï¸', 'ğŸš‚', 'ğŸšƒ', 'ğŸš„', 'ğŸš…',
      'ğŸš†', 'ğŸš‡', 'ğŸšˆ', 'ğŸš‰', 'ğŸšŠ', 'ğŸš', 'ğŸš', 'ğŸš‹', 'ğŸšŒ', 'ğŸš',
      'ğŸš', 'ğŸš', 'ğŸš‘', 'ğŸš’', 'ğŸš“', 'ğŸš”', 'ğŸš•', 'ğŸš–', 'ğŸš—', 'ğŸš˜',
      'ğŸš™', 'ğŸ›»', 'ğŸšš', 'ğŸš›', 'ğŸšœ', 'ğŸï¸', 'ğŸï¸', 'ğŸ›µ', 'ğŸ¦½', 'ğŸ¦¼',
      'ğŸ›´', 'ğŸš²', 'ğŸ›¹', 'ğŸ›¼', 'ğŸš', 'ğŸ›¸', 'ğŸš€', 'âœˆï¸', 'ğŸ›©ï¸', 'ğŸ›«'
    ]
  },
  objects: {
    name: 'ç‰©å“',
    icon: 'âŒš',
    emojis: [
      'âŒš', 'ğŸ“±', 'ğŸ“²', 'ğŸ’»', 'âŒ¨ï¸', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'ğŸ–±ï¸', 'ğŸ–²ï¸', 'ğŸ•¹ï¸',
      'ğŸ—œï¸', 'ğŸ’½', 'ğŸ’¾', 'ğŸ’¿', 'ğŸ“€', 'ğŸ“¼', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¹', 'ğŸ¥',
      'ğŸ“½ï¸', 'ğŸï¸', 'ğŸ“', 'â˜ï¸', 'ğŸ“Ÿ', 'ğŸ“ ', 'ğŸ“º', 'ğŸ“»', 'ğŸ™ï¸', 'ğŸšï¸',
      'ğŸ›ï¸', 'ğŸ§­', 'â±ï¸', 'â²ï¸', 'â°', 'ğŸ•°ï¸', 'âŒ›', 'â³', 'ğŸ“¡', 'ğŸ”‹',
      'ğŸ”Œ', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ•¯ï¸', 'ğŸª”', 'ğŸ§¯', 'ğŸ›¢ï¸', 'ğŸ’¸', 'ğŸ’µ', 'ğŸ’´',
      'ğŸ’¶', 'ğŸ’·', 'ğŸ’°', 'ğŸ’³', 'ğŸ’', 'âš–ï¸', 'ğŸ§°', 'ğŸ”§', 'ğŸ”¨', 'âš’ï¸',
      'ğŸ› ï¸', 'â›ï¸', 'ğŸ”©', 'âš™ï¸', 'ğŸ§±', 'â›“ï¸', 'ğŸ§²', 'ğŸ”«', 'ğŸ’£', 'ğŸ§¨',
      'ğŸª“', 'ğŸ”ª', 'ğŸ—¡ï¸', 'âš”ï¸', 'ğŸ›¡ï¸', 'ğŸš¬', 'âš°ï¸', 'ğŸª¦', 'âš±ï¸', 'ğŸº'
    ]
  },
  symbols: {
    name: 'ç¬¦å·',
    icon: 'â¤ï¸',
    emojis: [
      'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”',
      'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'â˜®ï¸',
      'âœï¸', 'â˜ªï¸', 'ğŸ•‰ï¸', 'â˜¸ï¸', 'âœ¡ï¸', 'ğŸ”¯', 'ğŸ•', 'â˜¯ï¸', 'â˜¦ï¸', 'ğŸ›',
      'â›', 'â™ˆ', 'â™‰', 'â™Š', 'â™‹', 'â™Œ', 'â™', 'â™', 'â™', 'â™',
      'â™‘', 'â™’', 'â™“', 'ğŸ†”', 'âš›ï¸', 'ğŸ‰‘', 'â˜¢ï¸', 'â˜£ï¸', 'ğŸ“´', 'ğŸ“³',
      'ğŸˆ¶', 'ğŸˆš', 'ğŸˆ¸', 'ğŸˆº', 'ğŸˆ·ï¸', 'âœ´ï¸', 'ğŸ†š', 'ğŸ’®', 'ğŸ‰', 'ãŠ™ï¸',
      'ãŠ—ï¸', 'ğŸˆ´', 'ğŸˆµ', 'ğŸˆ¹', 'ğŸˆ²', 'ğŸ…°ï¸', 'ğŸ…±ï¸', 'ğŸ†', 'ğŸ†‘', 'ğŸ…¾ï¸',
      'ğŸ†˜', 'âŒ', 'â­•', 'ğŸ›‘', 'â›”', 'ğŸ“›', 'ğŸš«', 'ğŸ’¯', 'ğŸ’¢', 'â™¨ï¸'
    ]
  },
  flags: {
    name: 'æ——å¸œ',
    icon: 'ğŸ',
    emojis: [
      'ğŸ', 'ğŸš©', 'ğŸŒ', 'ğŸ´', 'ğŸ³ï¸', 'ğŸ³ï¸â€ğŸŒˆ', 'ğŸ³ï¸â€âš§ï¸', 'ğŸ´â€â˜ ï¸', 'ğŸ‡¦ğŸ‡«', 'ğŸ‡¦ğŸ‡½',
      'ğŸ‡¦ğŸ‡±', 'ğŸ‡©ğŸ‡¿', 'ğŸ‡¦ğŸ‡¸', 'ğŸ‡¦ğŸ‡©', 'ğŸ‡¦ğŸ‡´', 'ğŸ‡¦ğŸ‡®', 'ğŸ‡¦ğŸ‡¶', 'ğŸ‡¦ğŸ‡¬', 'ğŸ‡¦ğŸ‡·', 'ğŸ‡¦ğŸ‡²',
      'ğŸ‡¦ğŸ‡¼', 'ğŸ‡¦ğŸ‡º', 'ğŸ‡¦ğŸ‡¹', 'ğŸ‡¦ğŸ‡¿', 'ğŸ‡§ğŸ‡¸', 'ğŸ‡§ğŸ‡­', 'ğŸ‡§ğŸ‡©', 'ğŸ‡§ğŸ‡§', 'ğŸ‡§ğŸ‡¾', 'ğŸ‡§ğŸ‡ª',
      'ğŸ‡§ğŸ‡¿', 'ğŸ‡§ğŸ‡¯', 'ğŸ‡§ğŸ‡²', 'ğŸ‡§ğŸ‡¹', 'ğŸ‡§ğŸ‡´', 'ğŸ‡§ğŸ‡¦', 'ğŸ‡§ğŸ‡¼', 'ğŸ‡§ğŸ‡·', 'ğŸ‡®ğŸ‡´', 'ğŸ‡»ğŸ‡¬',
      'ğŸ‡§ğŸ‡³', 'ğŸ‡§ğŸ‡¬', 'ğŸ‡§ğŸ‡«', 'ğŸ‡§ğŸ‡®', 'ğŸ‡°ğŸ‡­', 'ğŸ‡¨ğŸ‡²', 'ğŸ‡¨ğŸ‡¦', 'ğŸ‡®ğŸ‡¨', 'ğŸ‡¨ğŸ‡»', 'ğŸ‡§ğŸ‡¶',
      'ğŸ‡°ğŸ‡¾', 'ğŸ‡¨ğŸ‡«', 'ğŸ‡¹ğŸ‡©', 'ğŸ‡¨ğŸ‡±', 'ğŸ‡¨ğŸ‡³', 'ğŸ‡¨ğŸ‡½', 'ğŸ‡¨ğŸ‡¨', 'ğŸ‡¨ğŸ‡´', 'ğŸ‡°ğŸ‡²', 'ğŸ‡¨ğŸ‡¬',
      'ğŸ‡¨ğŸ‡©', 'ğŸ‡¨ğŸ‡°', 'ğŸ‡¨ğŸ‡·', 'ğŸ‡¨ğŸ‡®', 'ğŸ‡­ğŸ‡·', 'ğŸ‡¨ğŸ‡º', 'ğŸ‡¨ğŸ‡¼', 'ğŸ‡¨ğŸ‡¾', 'ğŸ‡¨ğŸ‡¿', 'ğŸ‡©ğŸ‡°',
      'ğŸ‡©ğŸ‡¯', 'ğŸ‡©ğŸ‡²', 'ğŸ‡©ğŸ‡´', 'ğŸ‡ªğŸ‡¨', 'ğŸ‡ªğŸ‡¬', 'ğŸ‡¸ğŸ‡»', 'ğŸ‡¬ğŸ‡¶', 'ğŸ‡ªğŸ‡·', 'ğŸ‡ªğŸ‡ª', 'ğŸ‡ªğŸ‡¹'
    ]
  }
};

type CategoryKey = keyof typeof EMOJI_CATEGORIES;

const EmojiPicker: React.FC<EmojiPickerProps> = ({ visible, onEmojiSelect, onClose }) => {
  const { theme } = useTheme();
  const [selectedCategory, setSelectedCategory] = useState<CategoryKey>('smileys');
  const [loadedCategories, setLoadedCategories] = useState<Set<CategoryKey>>(new Set(['smileys']));
  const slideAnim = useRef(new Animated.Value(0)).current;
  const opacityAnim = useRef(new Animated.Value(0)).current;
  
  // åŠ¨ç”»æ•ˆæœ
  useEffect(() => {
    if (visible) {
      Animated.parallel([
        Animated.timing(slideAnim, {
          toValue: 1,
          duration: 300,
          useNativeDriver: true,
        }),
        Animated.timing(opacityAnim, {
          toValue: 1,
          duration: 200,
          useNativeDriver: true,
        }),
      ]).start();
    } else {
      Animated.parallel([
        Animated.timing(slideAnim, {
          toValue: 0,
          duration: 250,
          useNativeDriver: true,
        }),
        Animated.timing(opacityAnim, {
          toValue: 0,
          duration: 150,
          useNativeDriver: true,
        }),
      ]).start();
    }
  }, [visible]);
  
  // ç›‘å¬åˆ†ç±»åˆ‡æ¢ï¼Œè‡ªåŠ¨åŠ è½½å¯¹åº”åˆ†ç±»çš„è¡¨æƒ…
  useEffect(() => {
    if (!loadedCategories.has(selectedCategory)) {
      setLoadedCategories(prev => new Set([...prev, selectedCategory]));
    }
  }, [selectedCategory, loadedCategories]);
  
  // æ‡’åŠ è½½åˆ†ç±»
  const loadCategory = (category: CategoryKey) => {
    if (!loadedCategories.has(category)) {
      setLoadedCategories(prev => new Set([...prev, category]));
    }
    setSelectedCategory(category);
  };
  
  // è·å–å½“å‰åˆ†ç±»çš„è¡¨æƒ…
  const getCurrentEmojis = () => {
    if (!loadedCategories.has(selectedCategory)) {
      return [];
    }
    return EMOJI_CATEGORIES[selectedCategory].emojis;
  };
  
  const styles = useMemo(() => StyleSheet.create({
    overlay: {
      position: 'absolute',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      backgroundColor: 'rgba(0, 0, 0, 0.3)',
      zIndex: 1000,
    },
    container: {
      position: 'absolute',
      bottom: 0,
      left: 0,
      right: 0,
      height: height * 0.5,
      backgroundColor: theme.colors.surface,
      borderTopLeftRadius: theme.borderRadius.lg,
      borderTopRightRadius: theme.borderRadius.lg,
      shadowColor: theme.colors.shadow,
      shadowOffset: {
        width: 0,
        height: -2,
      },
      shadowOpacity: 0.25,
      shadowRadius: 3.84,
      elevation: 5,
      overflow: 'hidden',
    },
    header: {
      flexDirection: 'row',
      alignItems: 'center',
      justifyContent: 'space-between',
      paddingHorizontal: theme.spacing.lg,
      paddingVertical: theme.spacing.md,
      borderBottomWidth: 1,
      borderBottomColor: theme.colors.inputBorder,
    },
    title: {
      fontSize: 16,
      fontWeight: '600',
      color: theme.colors.text,
    },
    closeButton: {
      padding: theme.spacing.xs,
      borderRadius: theme.borderRadius.sm,
      backgroundColor: theme.colors.textSecondary + '20',
    },
    closeButtonText: {
      fontSize: 16,
      color: theme.colors.textSecondary,
      fontWeight: '600',
    },
    categoryTabs: {
      maxHeight: 60,
      paddingVertical: theme.spacing.sm,
      borderBottomWidth: 1,
      borderBottomColor: theme.colors.inputBorder,
    },
    categoryTab: {
      paddingHorizontal: theme.spacing.md,
      paddingVertical: theme.spacing.sm,
      marginHorizontal: theme.spacing.xs,
      borderRadius: theme.borderRadius.md,
      minWidth: 50,
      alignItems: 'center',
      justifyContent: 'center',
    },
    categoryTabActive: {
      backgroundColor: theme.colors.primary + '20',
    },
    categoryName: {
      fontSize: 16,
      color: theme.colors.textSecondary,
      fontWeight: '500',
    },
    categoryNameActive: {
      color: theme.colors.primary,
    },
    emojiContainer: {
      flex: 1,
      paddingHorizontal: theme.spacing.md,
      paddingTop: theme.spacing.sm,
    },
    emojiGrid: {
      flexDirection: 'row',
      flexWrap: 'wrap',
      justifyContent: 'space-between',
    },
    emojiItem: {
      width: (width - theme.spacing.md * 2) / 8,
      aspectRatio: 1,
      justifyContent: 'center',
      alignItems: 'center',
      marginBottom: theme.spacing.sm,
      borderRadius: theme.borderRadius.sm,
    },
    emojiText: {
      fontSize: 24,
    },
    loadingContainer: {
      flex: 1,
      justifyContent: 'center',
      alignItems: 'center',
      paddingVertical: theme.spacing.xl,
    },
    loadingText: {
      fontSize: 14,
      color: theme.colors.textSecondary,
      marginTop: theme.spacing.sm,
    },
  }), [theme, width, height]);
  
  const translateY = slideAnim.interpolate({
    inputRange: [0, 1],
    outputRange: [height * 0.5, 0],
  });
  
  if (!visible) {
    return null;
  }
  
  return (
    <>
      <Animated.View 
        style={[styles.overlay, { opacity: opacityAnim }]}
      >
        <TouchableOpacity 
          style={{ flex: 1 }}
          activeOpacity={1}
          onPress={onClose}
        />
      </Animated.View>
      <Animated.View 
        style={[
          styles.container,
          {
            transform: [{ translateY }],
            opacity: opacityAnim,
          }
        ]}
      >
        {/* å¤´éƒ¨ */}
        <View style={styles.header}>
          <Text style={styles.title}>é€‰æ‹©è¡¨æƒ…</Text>
          <TouchableOpacity style={styles.closeButton} onPress={onClose}>
            <Text style={styles.closeButtonText}>Ã—</Text>
          </TouchableOpacity>
        </View>
        
        {/* åˆ†ç±»æ ‡ç­¾ */}
        <ScrollView 
          horizontal 
          showsHorizontalScrollIndicator={true}
          style={styles.categoryTabs}
          contentContainerStyle={{ paddingHorizontal: theme.spacing.sm }}
          bounces={false}
          decelerationRate="fast"
        >
          {Object.entries(EMOJI_CATEGORIES).map(([key, category]) => {
            const categoryKey = key as CategoryKey;
            const isActive = selectedCategory === categoryKey;
            
            return (
              <TouchableOpacity
                key={key}
                style={[
                  styles.categoryTab,
                  isActive && styles.categoryTabActive
                ]}
                onPress={(e) => {
                  e.stopPropagation();
                  loadCategory(categoryKey);
                }}
                activeOpacity={0.7}
              >
                <Text style={[
                  styles.categoryName,
                  isActive && styles.categoryNameActive
                ]}>
                  {category.name}
                </Text>
              </TouchableOpacity>
            );
          })}
        </ScrollView>
        
        {/* è¡¨æƒ…ç½‘æ ¼ */}
        <View style={styles.emojiContainer}>
          {loadedCategories.has(selectedCategory) ? (
            <FlatList
              data={getCurrentEmojis()}
              numColumns={8}
              showsVerticalScrollIndicator={true}
              keyExtractor={(item, index) => `${selectedCategory}-${index}`}
              renderItem={({ item: emoji }) => (
                <TouchableOpacity
                  style={styles.emojiItem}
                  onPress={() => onEmojiSelect(emoji)}
                  activeOpacity={0.7}
                >
                  <Text style={styles.emojiText}>{emoji}</Text>
                </TouchableOpacity>
              )}
              contentContainerStyle={{
                paddingBottom: theme.spacing.md,
              }}
              removeClippedSubviews={false}
              maxToRenderPerBatch={40}
              windowSize={10}
              initialNumToRender={40}
            />
          ) : (
            <View style={styles.loadingContainer}>
              <Text style={styles.loadingText}>åŠ è½½ä¸­...</Text>
            </View>
          )}
        </View>
      </Animated.View>
    </>
  );
};

export default EmojiPicker;
export { EMOJI_CATEGORIES };
export type { CategoryKey };